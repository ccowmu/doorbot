= Door Bot =

Door Bot is the automated door lock system for the CCaWMU office. It lets club members unlock the office door remotely from a web interface — click a button, and the deadbolt turns.

== How It Works ==

<pre>
┌──────────────┐         HTTP          ┌──────────────────┐        GPIO         ┌─────────────┐
│   Browser    │ ───────────────────▶  │  Server (yakko)  │  ◀── poll 1s ───  │  Pi Client  │
│  "Unlock!"   │                       │  :8878           │  ──── unlock ──▶  │  (doorbot)  │
└──────────────┘                       └──────────────────┘                    └──────┬──────┘
                                                                                     │
                                                                              ┌──────▼──────┐
                                                                              │ Stepper     │
                                                                              │ Motor +     │
                                                                              │ Deadbolt    │
                                                                              └─────────────┘
</pre>

# A user sends $letmein in Matrix chat (or visits the web UI at http://yakko.cs.wmich.edu:8878)
# The server sets an unlock flag
# The Pi client polls the server every second — when it sees the flag, it:
#* Powers the relay and drives the stepper motor to turn the deadbolt
#* Waits for the limit switch to confirm the lock is open
#* Plays a sound through the speaker
#* Holds the door unlocked for '''10 seconds'''
#* Reverses the motor to re-lock
# The server can optionally specify which sound to play

== Chat Commands ==

Control the door from Matrix chat:

* <code>$letmein</code> — Unlock the door (random sound)
* <code>$letmein <sound.wav></code> — Unlock and play a specific sound
* <code>$letmein sneaky</code> — Unlock silently (no sound)
* <code>$letmein sounds</code> — List available sounds
* <code>$letmein help</code> — Show help message

== Hardware ==

{| class="wikitable"
! Component !! Details
|-
| '''Computer''' || Raspberry Pi Model B Rev 2
|-
| '''Hostname''' || <code>doorbot</code>
|-
| '''IP Address''' || <code>192.168.1.193</code>
|-
| '''Motor''' || Stepper motor driving the deadbolt via PWM
|-
| '''Relay''' || Controls motor power
|-
| '''Limit Switch''' || Detects when the lock reaches the open position
|-
| '''Speaker''' || Plays <code>.wav</code> files on unlock
|}

=== GPIO Pinout (BCM) ===

{| class="wikitable"
! Pin !! Function
|-
| GPIO 4 || Relay (motor power)
|-
| GPIO 15 || Motor direction
|-
| GPIO 18 || Motor PWM signal
|-
| GPIO 7 || Limit switch / position sensor
|}

=== Motor Parameters ===

{| class="wikitable"
! Parameter !! Value
|-
| PWM Frequency || 500 Hz
|-
| Duty Cycle || 50%
|-
| Unlock Hold Time || 10 seconds
|-
| Reverse Time || 6.5 seconds
|-
| Sound Max Duration || 10 seconds
|}

== Software ==

All source code lives in one repo: [https://github.com/ccowmu/doorbot https://github.com/ccowmu/doorbot]

The Pi automatically mirrors this repo. Push to <code>main</code> and the changes go live within 60 seconds — no SSH required.

=== Repository Contents ===

* <code>doorbot_client.py</code> — Main client — polls server, drives hardware
* <code>doorbot-client.service</code> — Systemd unit for the client
* <code>doorbot-sync.sh</code> — Auto-sync script (fetch + reset + restart)
* <code>doorbot-sync.service</code> — Systemd unit for sync
* <code>doorbot-sync.timer</code> — Runs sync every 60 seconds
* <code>sync_sounds.sh</code> — Pulls .wav files from Proton Drive
* <code>sounds-sync.service</code> — Systemd unit for sound sync
* <code>sounds-sync.timer</code> — Runs sound sync every 5 minutes
* <code>setup_doorbot.sh</code> — Fresh Pi provisioning script

=== Systemd Services ===

{| class="wikitable"
! Service !! What It Does
|-
| <code>doorbot-client.service</code> || Runs the client. Starts on boot, restarts on failure.
|-
| <code>doorbot-sync.timer</code> || Every 60s: pulls from GitHub, restarts client if code changed.
|-
| <code>sounds-sync.timer</code> || Every 5min: syncs <code>.wav</code> files from Proton Drive via rclone.
|}

== Sounds ==

The doorbot plays a random <code>.wav</code> file each time the door unlocks. The server can also request a specific sound by name.

=== Adding Sounds ===

Upload <code>.wav</code> files to the shared '''Proton Drive''' <code>sounds</code> folder. They sync to the Pi automatically every 5 minutes via rclone.

== Common Commands ==

<syntaxhighlight lang="bash">
# Check if the client is running
sudo systemctl status doorbot-client

# View live logs
sudo journalctl -u doorbot-client -f

# Force an immediate sync from GitHub
/home/doorbot/doorbot/doorbot-sync.sh
</syntaxhighlight>

== See Also ==

=== LEDBox (Office Lighting) ===
* '''Wiki:''' [[LEDBox]]
* '''GitHub:''' [https://github.com/ccowmu/LEDBox ccowmu/LEDBox]

=== Office-IoT (Central Server) ===
* '''Wiki:''' [[Office-IoT]]
* '''GitHub:''' [https://github.com/ccowmu/Office-IoT ccowmu/Office-IoT]
